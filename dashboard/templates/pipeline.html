{% extends "base.html" %}

{% block title %}Pipeline — Ecosystem Research{% endblock %}

{% block content %}
<div class="pipeline-section">
    <h2>Enrichment Pipeline</h2>

    <!-- Panel 0: Add New Chain -->
    <div class="panel add-chain-panel">
        <h3>0. Add New Chain</h3>
        <div class="upload-controls">
            <div class="filter-group">
                <label for="new-chain-id">Chain ID</label>
                <input type="text" id="new-chain-id" placeholder="e.g. solana" pattern="[a-z0-9\-]+">
            </div>
            <div class="filter-group">
                <label for="new-chain-name">Display Name</label>
                <input type="text" id="new-chain-name" placeholder="e.g. Solana">
            </div>
            <div class="filter-group">
                <label for="new-chain-slug">DefiLlama Slug</label>
                <input type="text" id="new-chain-slug" placeholder="e.g. Solana">
            </div>
            <div class="filter-group">
                <label for="new-chain-assets">Target Assets</label>
                <input type="text" id="new-chain-assets" placeholder="USDT,USDC" value="USDT,USDC">
            </div>
            <button class="btn" id="btn-add-chain" onclick="addChain()">Add Chain</button>
        </div>
        <div id="add-chain-status" class="status-msg"></div>
        <details class="slug-help">
            <summary>Common DefiLlama slugs</summary>
            <table class="slug-table">
                <tr><td>Ethereum</td><td>Solana</td><td>Polygon</td><td>Arbitrum</td></tr>
                <tr><td>Base</td><td>Optimism</td><td>BSC</td><td>Avalanche</td></tr>
                <tr><td>Cardano</td><td>Aptos</td><td>Sui</td><td>Near</td></tr>
                <tr><td>Fantom</td><td>Tron</td><td>Cosmos</td><td>Polkadot</td></tr>
            </table>
            <small class="slug-hint">Case-sensitive. Check <a href="https://defillama.com/chains" target="_blank">defillama.com/chains</a> for the exact name.</small>
        </details>
    </div>

    <!-- Panel 1: Discover Projects -->
    <div class="panel discover-panel">
        <h3>1. Discover Projects</h3>
        <div class="upload-controls">
            <div class="filter-group">
                <label for="discover-chain">Chain</label>
                <select id="discover-chain" onchange="loadSources()">
                    {% for c in chain_data %}
                    <option value="{{ c.id }}" {% if c.id == chain %}selected{% endif %}
                            data-rows="{{ c.row_count }}" data-has-data="{{ c.has_data|lower }}">
                        {{ c.name }}{% if c.has_data %} ({{ c.row_count }} rows){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>Sources</label>
                <div id="discover-sources" class="source-checkboxes">
                    <label class="step-checkbox">
                        <input type="checkbox" name="discover-source" value="defillama" checked>
                        <span class="step-name">DefiLlama</span>
                        <span class="step-desc">DeFi protocols with TVL</span>
                    </label>
                </div>
            </div>
            <button class="btn btn-discover" id="btn-discover" onclick="startDiscovery()">
                Discover
            </button>
        </div>
        <div id="discover-progress" class="discover-progress" style="display: none;">
            <div class="progress-bar-container">
                <div class="progress-bar" id="discover-bar"></div>
            </div>
            <div id="discover-message" class="status-msg"></div>
        </div>
        <div id="discover-result" class="status-msg"></div>
    </div>

    <!-- Panel 2: Upload CSV -->
    <div class="panel upload-panel">
        <h3>2. Upload CSV</h3>
        <div class="upload-controls">
            <div class="filter-group">
                <label for="upload-chain">Chain</label>
                <select id="upload-chain">
                    {% for c in chain_data %}
                    <option value="{{ c.id }}" {% if c.id == chain %}selected{% endif %}
                            data-rows="{{ c.row_count }}" data-has-data="{{ c.has_data|lower }}">
                        {{ c.name }}{% if c.has_data %} ({{ c.row_count }} rows){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="csv-file">CSV File</label>
                <input type="file" id="csv-file" accept=".csv">
            </div>
            <button class="btn" id="btn-upload" onclick="uploadCSV()">Upload</button>
        </div>
        <div id="upload-status" class="status-msg"></div>
    </div>

    <!-- Panel 3: Enrichment Controls -->
    <div class="panel controls-panel">
        <h3>3. Configure &amp; Run</h3>
        <div class="step-checkboxes">
            {% for s in steps %}
            <label class="step-checkbox">
                <input type="checkbox" name="step" value="{{ s }}" checked>
                <span class="step-name">{{ s }}</span>
                <span class="step-desc">{{ step_descriptions[s] }}</span>
            </label>
            {% endfor %}
        </div>
        <div class="controls-actions">
            <button class="btn btn-run" id="btn-run" onclick="startPipeline()">
                Run Enrichment
            </button>
            <a class="btn btn-secondary" id="btn-download"
               href="/api/download/{{ chain }}" download>
                Download CSV
            </a>
        </div>
    </div>

    <!-- Panel 4: Progress -->
    <div class="panel progress-panel" id="progress-panel" style="display: none;">
        <h3>4. Progress</h3>
        <div class="step-list" id="step-list"></div>
        <div class="pipeline-summary" id="pipeline-summary"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let currentJobId = null;
    let pollTimer = null;
    let discoveryJobId = null;
    let discoveryPollTimer = null;

    // ── Add Chain ──

    window.addChain = function() {
        const id = document.getElementById('new-chain-id').value.trim().toLowerCase();
        const name = document.getElementById('new-chain-name').value.trim();
        const slug = document.getElementById('new-chain-slug').value.trim();
        const assets = document.getElementById('new-chain-assets').value.trim();
        const statusEl = document.getElementById('add-chain-status');

        if (!id || !name || !slug) {
            statusEl.textContent = 'Please fill in Chain ID, Display Name, and DefiLlama Slug.';
            statusEl.className = 'status-msg error';
            return;
        }

        statusEl.textContent = 'Adding chain...';
        statusEl.className = 'status-msg';
        document.getElementById('btn-add-chain').disabled = true;

        fetch('/api/chains/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: id,
                name: name,
                defillama_slug: slug,
                target_assets: assets,
            }),
        })
        .then(r => r.json().then(d => ({ ok: r.ok, data: d })))
        .then(({ ok, data }) => {
            if (ok) {
                statusEl.textContent = data.message + ' — reloading...';
                statusEl.className = 'status-msg success';
                setTimeout(() => window.location.reload(), 1000);
            } else {
                statusEl.textContent = data.error || 'Failed to add chain';
                statusEl.className = 'status-msg error';
                document.getElementById('btn-add-chain').disabled = false;
            }
        })
        .catch(err => {
            statusEl.textContent = 'Network error: ' + err.message;
            statusEl.className = 'status-msg error';
            document.getElementById('btn-add-chain').disabled = false;
        });
    };

    // ── Discover Projects ──

    window.loadSources = function() {
        const chain = document.getElementById('discover-chain').value;
        fetch(`/api/discover/sources/${chain}`)
            .then(r => r.json())
            .then(sources => {
                const container = document.getElementById('discover-sources');
                container.innerHTML = sources.map(s => `
                    <label class="step-checkbox">
                        <input type="checkbox" name="discover-source" value="${s.id}" checked>
                        <span class="step-name">${s.name}</span>
                        <span class="step-desc">${s.description}</span>
                    </label>
                `).join('');
            })
            .catch(() => {});
    };

    window.startDiscovery = function() {
        const chain = document.getElementById('discover-chain').value;
        const checkboxes = document.querySelectorAll('input[name="discover-source"]:checked');
        const sources = Array.from(checkboxes).map(cb => cb.value);
        const resultEl = document.getElementById('discover-result');

        if (!sources.length) {
            resultEl.textContent = 'Please select at least one source.';
            resultEl.className = 'status-msg error';
            return;
        }

        const btn = document.getElementById('btn-discover');
        btn.disabled = true;
        btn.textContent = 'Discovering...';
        resultEl.textContent = '';
        resultEl.className = 'status-msg';

        fetch('/api/discover/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chain, sources }),
        })
        .then(r => r.json().then(d => ({ ok: r.ok, data: d })))
        .then(({ ok, data }) => {
            if (ok) {
                discoveryJobId = data.job_id;
                showDiscoverProgress();
                startDiscoveryPolling();
            } else {
                resultEl.textContent = data.error || 'Failed to start discovery';
                resultEl.className = 'status-msg error';
                btn.disabled = false;
                btn.textContent = 'Discover';
            }
        })
        .catch(err => {
            resultEl.textContent = 'Network error: ' + err.message;
            resultEl.className = 'status-msg error';
            btn.disabled = false;
            btn.textContent = 'Discover';
        });
    };

    function showDiscoverProgress() {
        document.getElementById('discover-progress').style.display = '';
        document.getElementById('discover-bar').style.width = '0%';
        document.getElementById('discover-message').textContent = 'Starting discovery...';
    }

    function startDiscoveryPolling() {
        if (discoveryPollTimer) clearInterval(discoveryPollTimer);
        discoveryPollTimer = setInterval(pollDiscovery, 1500);
        pollDiscovery();
    }

    function pollDiscovery() {
        if (!discoveryJobId) return;

        fetch(`/api/discover/status/${discoveryJobId}`)
            .then(r => r.json())
            .then(job => {
                const bar = document.getElementById('discover-bar');
                const msg = document.getElementById('discover-message');
                const resultEl = document.getElementById('discover-result');

                msg.textContent = job.progress_message || '';

                if (job.progress_total > 0) {
                    const pct = Math.round((job.progress / job.progress_total) * 100);
                    bar.style.width = pct + '%';
                } else if (job.status === 'running') {
                    bar.style.width = '30%'; // indeterminate
                }

                if (job.status === 'completed') {
                    bar.style.width = '100%';
                    clearInterval(discoveryPollTimer);
                    discoveryPollTimer = null;

                    const r = job.result || {};
                    resultEl.textContent = `Added ${r.added || 0} projects (${r.duplicates || 0} duplicates skipped). Total: ${r.total_rows || 0} rows.`;
                    resultEl.className = 'status-msg success';

                    const btn = document.getElementById('btn-discover');
                    btn.disabled = false;
                    btn.textContent = 'Discover';

                    // Refresh chain dropdowns to show new row counts
                    refreshChainDropdowns();
                } else if (job.status === 'failed') {
                    bar.style.width = '100%';
                    bar.classList.add('progress-bar-error');
                    clearInterval(discoveryPollTimer);
                    discoveryPollTimer = null;

                    resultEl.textContent = 'Discovery failed: ' + (job.error || 'unknown error');
                    resultEl.className = 'status-msg error';

                    const btn = document.getElementById('btn-discover');
                    btn.disabled = false;
                    btn.textContent = 'Discover';
                }
            })
            .catch(() => {});
    }

    function refreshChainDropdowns() {
        fetch('/api/chains')
            .then(r => r.json())
            .then(chains => {
                ['upload-chain', 'discover-chain'].forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    const currentVal = select.value;
                    select.innerHTML = chains.map(c => {
                        const label = c.has_data ? `${c.name} (${c.row_count} rows)` : c.name;
                        const selected = c.id === currentVal ? ' selected' : '';
                        return `<option value="${c.id}"${selected}>${label}</option>`;
                    }).join('');
                });
                // Update download link
                const dlBtn = document.getElementById('btn-download');
                if (dlBtn) dlBtn.href = '/api/download/' + document.getElementById('upload-chain').value;
            })
            .catch(() => {});
    }

    // ── Upload CSV ──

    window.uploadCSV = function() {
        const chain = document.getElementById('upload-chain').value;
        const fileInput = document.getElementById('csv-file');
        const statusEl = document.getElementById('upload-status');

        if (!fileInput.files.length) {
            statusEl.textContent = 'Please select a CSV file.';
            statusEl.className = 'status-msg error';
            return;
        }

        const formData = new FormData();
        formData.append('chain', chain);
        formData.append('file', fileInput.files[0]);

        statusEl.textContent = 'Uploading...';
        statusEl.className = 'status-msg';
        document.getElementById('btn-upload').disabled = true;

        fetch('/api/upload', { method: 'POST', body: formData })
            .then(r => r.json().then(d => ({ ok: r.ok, data: d })))
            .then(({ ok, data }) => {
                if (ok) {
                    statusEl.textContent = data.message;
                    statusEl.className = 'status-msg success';
                    refreshChainDropdowns();
                } else {
                    statusEl.textContent = data.error || 'Upload failed';
                    statusEl.className = 'status-msg error';
                }
                document.getElementById('btn-upload').disabled = false;
            })
            .catch(err => {
                statusEl.textContent = 'Network error: ' + err.message;
                statusEl.className = 'status-msg error';
                document.getElementById('btn-upload').disabled = false;
            });
    };

    // ── Pipeline ──

    window.startPipeline = function() {
        const chain = document.getElementById('upload-chain').value;
        const checkboxes = document.querySelectorAll('input[name="step"]:not(:checked)');
        const skip = Array.from(checkboxes).map(cb => cb.value);

        const btnRun = document.getElementById('btn-run');
        btnRun.disabled = true;
        btnRun.textContent = 'Running...';

        fetch('/api/pipeline/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chain, skip }),
        })
        .then(r => r.json().then(d => ({ ok: r.ok, data: d })))
        .then(({ ok, data }) => {
            if (ok) {
                currentJobId = data.job_id;
                showProgress(data.steps);
                startPolling();
            } else {
                alert(data.error || 'Failed to start pipeline');
                btnRun.disabled = false;
                btnRun.textContent = 'Run Enrichment';
            }
        })
        .catch(err => {
            alert('Network error: ' + err.message);
            btnRun.disabled = false;
            btnRun.textContent = 'Run Enrichment';
        });
    };

    function showProgress(steps) {
        const panel = document.getElementById('progress-panel');
        panel.style.display = '';
        const list = document.getElementById('step-list');
        list.innerHTML = steps.map(name => `
            <div class="step-item step-pending" id="step-${name}">
                <span class="step-icon">&#9679;</span>
                <span class="step-label">${name}</span>
                <span class="step-result"></span>
            </div>
        `).join('');
        document.getElementById('pipeline-summary').textContent = '';
    }

    function startPolling() {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(pollStatus, 2000);
        pollStatus(); // immediate first poll
    }

    function pollStatus() {
        if (!currentJobId) return;

        fetch(`/api/pipeline/status/${currentJobId}`)
            .then(r => r.json())
            .then(job => {
                updateSteps(job.steps);
                updateSummary(job);

                if (job.status === 'completed' || job.status === 'failed') {
                    clearInterval(pollTimer);
                    pollTimer = null;
                    const btnRun = document.getElementById('btn-run');
                    btnRun.disabled = false;
                    btnRun.textContent = 'Run Enrichment';
                }
            })
            .catch(() => {});
    }

    function updateSteps(steps) {
        steps.forEach(step => {
            const el = document.getElementById(`step-${step.name}`);
            if (!el) return;

            // Remove old state classes
            el.className = 'step-item';

            const iconEl = el.querySelector('.step-icon');
            const resultEl = el.querySelector('.step-result');

            switch (step.status) {
                case 'pending':
                    el.classList.add('step-pending');
                    iconEl.innerHTML = '&#9679;';
                    resultEl.textContent = '';
                    break;
                case 'running':
                    el.classList.add('step-running');
                    iconEl.innerHTML = '&#9679;';
                    resultEl.textContent = 'running...';
                    break;
                case 'completed':
                    el.classList.add('step-completed');
                    iconEl.innerHTML = '&#10003;';
                    const parts = [];
                    if (step.result) {
                        Object.entries(step.result).forEach(([k, v]) => {
                            if (k !== 'elapsed') parts.push(`${k}=${v}`);
                        });
                    }
                    resultEl.textContent = parts.join(', ') + (step.elapsed ? ` (${step.elapsed}s)` : '');
                    break;
                case 'failed':
                    el.classList.add('step-failed');
                    iconEl.innerHTML = '&#10007;';
                    resultEl.textContent = step.error || 'failed';
                    break;
                case 'skipped':
                    el.classList.add('step-skipped');
                    iconEl.innerHTML = '&#8211;';
                    resultEl.textContent = 'skipped';
                    break;
            }
        });
    }

    function updateSummary(job) {
        const el = document.getElementById('pipeline-summary');
        if (job.status === 'completed') {
            el.className = 'pipeline-summary summary-success';
            el.textContent = `Pipeline completed in ${job.total_elapsed}s`;
        } else if (job.status === 'failed') {
            el.className = 'pipeline-summary summary-failed';
            el.textContent = `Pipeline failed: ${job.error || 'unknown error'} (${job.total_elapsed}s)`;
        } else if (job.status === 'running' && job.total_elapsed) {
            el.className = 'pipeline-summary';
            el.textContent = `Running... ${job.total_elapsed.toFixed(1)}s elapsed`;
        }
    }

    // Update download link when chain changes
    document.getElementById('upload-chain').addEventListener('change', function() {
        document.getElementById('btn-download').href = '/api/download/' + this.value;
    });

    // Load sources on page load
    loadSources();
})();
</script>
{% endblock %}
